# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# backup.yml - Database Backup Workflow
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Manual database backup workflow. Creates backups of linked databases and stores
# them on the Dokku server in /var/backups/dokku/{service}/{app}/
#
# Backups are gzip-compressed and named with timestamp: YYYYMMDD_HHMMSS.gz
#
# Required Secrets:
#   - DOKKU_HOST: Dokku server hostname
#   - DOKKU_SSH_PRIVATE_KEY: SSH private key
#
# Optional Secrets:
#   - SLACK_WEBHOOK_URL: Slack notifications
#   - DISCORD_WEBHOOK_URL: Discord notifications
#
# Server Setup Required:
#   sudo mkdir -p /var/backups/dokku/{postgres,mysql,redis,mongo,rabbitmq,elasticsearch}
#   sudo chown -R dokku:dokku /var/backups/dokku
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Database Backup

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name (leave empty for all apps)'
        required: false
        type: string
      service:
        description: 'Service type to backup'
        required: false
        type: choice
        options:
          - all
          - postgres
          - mysql
          - redis
          - mongo
          - rabbitmq
          - elasticsearch
        default: all
      reason:
        description: 'Backup reason (for logging)'
        required: false
        type: string
        default: 'Manual backup'

jobs:
  backup:
    name: Backup ${{ inputs.app_name || 'all apps' }}
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          cat >> ~/.ssh/config << EOF
          Host dokku
            HostName ${{ secrets.DOKKU_HOST }}
            User dokku
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Backup databases
        id: backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          APP_FILTER="${{ inputs.app_name }}"
          SERVICE_FILTER="${{ inputs.service }}"
          REASON="${{ inputs.reason }}"

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Database Backup"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Time: $TIMESTAMP"
          echo "  App: ${APP_FILTER:-all}"
          echo "  Service: ${SERVICE_FILTER:-all}"
          echo "  Reason: $REASON"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Get list of apps
          if [ -n "$APP_FILTER" ]; then
            APPS="$APP_FILTER"
          else
            APPS=$(ssh dokku apps:list | tail -n +2)
          fi

          BACKUP_COUNT=0
          BACKUP_LIST=""

          for APP in $APPS; do
            echo "Checking app: $APP"

            # PostgreSQL
            if [ "$SERVICE_FILTER" == "all" ] || [ "$SERVICE_FILTER" == "postgres" ]; then
              DB_NAME="postgres-$APP"
              if ssh dokku postgres:exists "$DB_NAME" 2>/dev/null; then
                BACKUP_DIR="/var/backups/dokku/postgres/$APP"
                BACKUP_FILE="$BACKUP_DIR/${TIMESTAMP}.gz"

                echo "  Backing up PostgreSQL: $DB_NAME"
                ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
                ssh dokku postgres:export "$DB_NAME" 2>/dev/null | gzip | \
                  ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"

                if [ $? -eq 0 ]; then
                  SIZE=$(ssh dokku@${{ secrets.DOKKU_HOST }} "ls -lh $BACKUP_FILE | awk '{print \$5}'")
                  echo "    âœ… Saved: $BACKUP_FILE ($SIZE)"
                  BACKUP_COUNT=$((BACKUP_COUNT + 1))
                  BACKUP_LIST="$BACKUP_LIST\nâ€¢ $APP (postgres): $SIZE"
                else
                  echo "    âŒ Failed to backup"
                fi
              fi
            fi

            # MySQL
            if [ "$SERVICE_FILTER" == "all" ] || [ "$SERVICE_FILTER" == "mysql" ]; then
              DB_NAME="mysql-$APP"
              if ssh dokku mysql:exists "$DB_NAME" 2>/dev/null; then
                BACKUP_DIR="/var/backups/dokku/mysql/$APP"
                BACKUP_FILE="$BACKUP_DIR/${TIMESTAMP}.gz"

                echo "  Backing up MySQL: $DB_NAME"
                ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
                ssh dokku mysql:export "$DB_NAME" 2>/dev/null | gzip | \
                  ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"

                if [ $? -eq 0 ]; then
                  SIZE=$(ssh dokku@${{ secrets.DOKKU_HOST }} "ls -lh $BACKUP_FILE | awk '{print \$5}'")
                  echo "    âœ… Saved: $BACKUP_FILE ($SIZE)"
                  BACKUP_COUNT=$((BACKUP_COUNT + 1))
                  BACKUP_LIST="$BACKUP_LIST\nâ€¢ $APP (mysql): $SIZE"
                else
                  echo "    âŒ Failed to backup"
                fi
              fi
            fi

            # Redis (RDB dump)
            if [ "$SERVICE_FILTER" == "all" ] || [ "$SERVICE_FILTER" == "redis" ]; then
              REDIS_NAME="redis-$APP"
              if ssh dokku redis:exists "$REDIS_NAME" 2>/dev/null; then
                BACKUP_DIR="/var/backups/dokku/redis/$APP"
                BACKUP_FILE="$BACKUP_DIR/${TIMESTAMP}.rdb.gz"

                echo "  Backing up Redis: $REDIS_NAME"
                ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
                ssh dokku redis:export "$REDIS_NAME" 2>/dev/null | gzip | \
                  ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"

                if [ $? -eq 0 ]; then
                  SIZE=$(ssh dokku@${{ secrets.DOKKU_HOST }} "ls -lh $BACKUP_FILE | awk '{print \$5}'")
                  echo "    âœ… Saved: $BACKUP_FILE ($SIZE)"
                  BACKUP_COUNT=$((BACKUP_COUNT + 1))
                  BACKUP_LIST="$BACKUP_LIST\nâ€¢ $APP (redis): $SIZE"
                else
                  echo "    âŒ Failed to backup"
                fi
              fi
            fi

            # MongoDB
            if [ "$SERVICE_FILTER" == "all" ] || [ "$SERVICE_FILTER" == "mongo" ]; then
              MONGO_NAME="mongo-$APP"
              if ssh dokku mongo:exists "$MONGO_NAME" 2>/dev/null; then
                BACKUP_DIR="/var/backups/dokku/mongo/$APP"
                BACKUP_FILE="$BACKUP_DIR/${TIMESTAMP}.gz"

                echo "  Backing up MongoDB: $MONGO_NAME"
                ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
                ssh dokku mongo:export "$MONGO_NAME" 2>/dev/null | gzip | \
                  ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"

                if [ $? -eq 0 ]; then
                  SIZE=$(ssh dokku@${{ secrets.DOKKU_HOST }} "ls -lh $BACKUP_FILE | awk '{print \$5}'")
                  echo "    âœ… Saved: $BACKUP_FILE ($SIZE)"
                  BACKUP_COUNT=$((BACKUP_COUNT + 1))
                  BACKUP_LIST="$BACKUP_LIST\nâ€¢ $APP (mongo): $SIZE"
                else
                  echo "    âŒ Failed to backup"
                fi
              fi
            fi

            # RabbitMQ (export definitions - queues are transient)
            if [ "$SERVICE_FILTER" == "all" ] || [ "$SERVICE_FILTER" == "rabbitmq" ]; then
              RABBITMQ_NAME="rabbitmq-$APP"
              if ssh dokku rabbitmq:exists "$RABBITMQ_NAME" 2>/dev/null; then
                BACKUP_DIR="/var/backups/dokku/rabbitmq/$APP"
                BACKUP_FILE="$BACKUP_DIR/${TIMESTAMP}.json.gz"

                echo "  Backing up RabbitMQ definitions: $RABBITMQ_NAME"
                ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
                # Export definitions (exchanges, queues, bindings, users, vhosts, permissions, policies)
                ssh dokku rabbitmq:export "$RABBITMQ_NAME" 2>/dev/null | gzip | \
                  ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"

                if [ $? -eq 0 ]; then
                  SIZE=$(ssh dokku@${{ secrets.DOKKU_HOST }} "ls -lh $BACKUP_FILE | awk '{print \$5}'")
                  echo "    âœ… Saved: $BACKUP_FILE ($SIZE)"
                  echo "    âš ï¸  Note: Only definitions exported, messages are not included"
                  BACKUP_COUNT=$((BACKUP_COUNT + 1))
                  BACKUP_LIST="$BACKUP_LIST\nâ€¢ $APP (rabbitmq): $SIZE"
                else
                  echo "    âŒ Failed to backup"
                fi
              fi
            fi

            # Elasticsearch (snapshot - requires manual setup)
            if [ "$SERVICE_FILTER" == "elasticsearch" ]; then
              ES_NAME="elasticsearch-$APP"
              if ssh dokku elasticsearch:exists "$ES_NAME" 2>/dev/null; then
                echo "  âš ï¸  Elasticsearch: $ES_NAME"
                echo "    Elasticsearch backups require snapshot repository configuration."
                echo "    See: https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore.html"
                echo "    Skipping automatic backup."
              fi
            fi
          done

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Backup Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Total backups created: $BACKUP_COUNT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo "backup_count=$BACKUP_COUNT" >> $GITHUB_OUTPUT
          echo "backup_list=$BACKUP_LIST" >> $GITHUB_OUTPUT

      - name: Cleanup old backups
        run: |
          echo "Cleaning up backups older than 14 days..."
          ssh dokku@${{ secrets.DOKKU_HOST }} "find /var/backups/dokku -type f -mtime +14 -delete 2>/dev/null || true"
          echo "Cleanup complete"

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0

          BACKUP_COUNT="${{ steps.backup.outputs.backup_count }}"

          if [ "$BACKUP_COUNT" -gt 0 ]; then
            COLOR="good"
            TITLE="Database Backup Complete"
            TEXT="$BACKUP_COUNT database(s) backed up"
          else
            COLOR="warning"
            TITLE="Database Backup"
            TEXT="No databases found to backup"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"text\": \"$TEXT\",
                \"fields\": [
                  {\"title\": \"App\", \"value\": \"${{ inputs.app_name || 'all' }}\", \"short\": true},
                  {\"title\": \"Service\", \"value\": \"${{ inputs.service }}\", \"short\": true},
                  {\"title\": \"Reason\", \"value\": \"${{ inputs.reason }}\", \"short\": false}
                ],
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          [ -z "$DISCORD_WEBHOOK_URL" ] && exit 0

          BACKUP_COUNT="${{ steps.backup.outputs.backup_count }}"

          if [ "$BACKUP_COUNT" -gt 0 ]; then
            COLOR=3066993
            TITLE="ðŸ’¾ Database Backup Complete"
            DESC="$BACKUP_COUNT database(s) backed up"
          else
            COLOR=16776960
            TITLE="ðŸ’¾ Database Backup"
            DESC="No databases found to backup"
          fi

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"description\": \"$DESC\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"App\", \"value\": \"${{ inputs.app_name || 'all' }}\", \"inline\": true},
                  {\"name\": \"Service\", \"value\": \"${{ inputs.service }}\", \"inline\": true},
                  {\"name\": \"Reason\", \"value\": \"${{ inputs.reason }}\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"Backup Workflow\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL" || true
