# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# preview.yml - Reusable Pull Request Preview Environments
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# REUSABLE WORKFLOW - Called by other repos via:
#   uses: signalwire-demos/dokku-deploy-system/.github/workflows/preview.yml@main
#
# Creates temporary preview environments for pull requests.
# Automatically deploys when a PR is opened/updated and destroys when closed.
#
# Required Secrets (set at org level):
#   - DOKKU_HOST: Dokku server hostname
#   - DOKKU_SSH_PRIVATE_KEY: SSH private key for deployment
#   - BASE_DOMAIN: Base domain for apps (e.g., yourdomain.com)
#
# Optional Secrets:
#   - PREVIEW_AUTH_USER: HTTP auth username for previews
#   - PREVIEW_AUTH_PASSWORD: HTTP auth password for previews
#
# Preview URL format: {app-name}-pr-{pr-number}.{base-domain}
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Preview Environment (Reusable)

on:
  workflow_call:
    inputs:
      memory_limit:
        description: 'Memory limit for preview apps'
        required: false
        type: string
        default: '256m'
      cpu_limit:
        description: 'CPU limit for preview apps'
        required: false
        type: string
        default: '0.5'
    secrets:
      DOKKU_HOST:
        required: true
      DOKKU_SSH_PRIVATE_KEY:
        required: true
      BASE_DOMAIN:
        required: true
      PREVIEW_AUTH_USER:
        required: false
      PREVIEW_AUTH_PASSWORD:
        required: false

env:
  BASE_APP_NAME: ${{ github.event.repository.name }}
  PR_NUMBER: ${{ github.event.pull_request.number }}
  APP_NAME: ${{ github.event.repository.name }}-pr-${{ github.event.pull_request.number }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Deploy Preview
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    environment: preview

    steps:
      - name: Create preview environment if needed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/${{ github.repository }}/environments/preview -X PUT 2>/dev/null || true

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          cat >> ~/.ssh/config << EOF
          Host dokku
            HostName ${{ secrets.DOKKU_HOST }}
            User dokku
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Create preview app
        run: |
          echo "Creating preview app: ${{ env.APP_NAME }}"
          ssh dokku apps:exists ${{ env.APP_NAME }} 2>/dev/null || \
          ssh dokku apps:create ${{ env.APP_NAME }}

      - name: Provision shared services
        run: |
          if [ -f ".dokku/services.yml" ]; then
            # Install yq
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq

            # PostgreSQL - use shared preview database
            if yq e '.services.postgres.enabled' .dokku/services.yml 2>/dev/null | grep -q "true"; then
              SHARED=$(yq e '.services.postgres.environments.preview.shared // false' .dokku/services.yml)
              if [ "$SHARED" == "true" ]; then
                DB_NAME="postgres-preview-shared"
              else
                DB_NAME="postgres-${{ env.APP_NAME }}"
              fi
              echo "Provisioning PostgreSQL: $DB_NAME"
              ssh dokku postgres:exists $DB_NAME 2>/dev/null || ssh dokku postgres:create $DB_NAME
              ssh dokku postgres:link $DB_NAME ${{ env.APP_NAME }} 2>/dev/null || true
            fi

            # Redis - use shared preview instance
            if yq e '.services.redis.enabled' .dokku/services.yml 2>/dev/null | grep -q "true"; then
              SHARED=$(yq e '.services.redis.environments.preview.shared // false' .dokku/services.yml)
              if [ "$SHARED" == "true" ]; then
                REDIS_NAME="redis-preview-shared"
              else
                REDIS_NAME="redis-${{ env.APP_NAME }}"
              fi
              echo "Provisioning Redis: $REDIS_NAME"
              ssh dokku redis:exists $REDIS_NAME 2>/dev/null || ssh dokku redis:create $REDIS_NAME
              ssh dokku redis:link $REDIS_NAME ${{ env.APP_NAME }} 2>/dev/null || true
            fi

            # MongoDB
            if yq e '.services.mongo.enabled' .dokku/services.yml 2>/dev/null | grep -q "true"; then
              PREVIEW_ENABLED=$(yq e '.services.mongo.environments.preview.enabled // true' .dokku/services.yml)
              if [ "$PREVIEW_ENABLED" != "false" ]; then
                SHARED=$(yq e '.services.mongo.environments.preview.shared // false' .dokku/services.yml)
                if [ "$SHARED" == "true" ]; then
                  MONGO_NAME="mongo-preview-shared"
                else
                  MONGO_NAME="mongo-${{ env.APP_NAME }}"
                fi
                echo "Provisioning MongoDB: $MONGO_NAME"
                ssh dokku mongo:exists $MONGO_NAME 2>/dev/null || ssh dokku mongo:create $MONGO_NAME
                ssh dokku mongo:link $MONGO_NAME ${{ env.APP_NAME }} 2>/dev/null || true
              fi
            fi

            # MySQL
            if yq e '.services.mysql.enabled' .dokku/services.yml 2>/dev/null | grep -q "true"; then
              PREVIEW_ENABLED=$(yq e '.services.mysql.environments.preview.enabled // true' .dokku/services.yml)
              if [ "$PREVIEW_ENABLED" != "false" ]; then
                SHARED=$(yq e '.services.mysql.environments.preview.shared // false' .dokku/services.yml)
                if [ "$SHARED" == "true" ]; then
                  MYSQL_NAME="mysql-preview-shared"
                else
                  MYSQL_NAME="mysql-${{ env.APP_NAME }}"
                fi
                echo "Provisioning MySQL: $MYSQL_NAME"
                ssh dokku mysql:exists $MYSQL_NAME 2>/dev/null || ssh dokku mysql:create $MYSQL_NAME
                ssh dokku mysql:link $MYSQL_NAME ${{ env.APP_NAME }} 2>/dev/null || true
              fi
            fi

            # RabbitMQ
            if yq e '.services.rabbitmq.enabled' .dokku/services.yml 2>/dev/null | grep -q "true"; then
              PREVIEW_ENABLED=$(yq e '.services.rabbitmq.environments.preview.enabled // true' .dokku/services.yml)
              if [ "$PREVIEW_ENABLED" != "false" ]; then
                SHARED=$(yq e '.services.rabbitmq.environments.preview.shared // false' .dokku/services.yml)
                if [ "$SHARED" == "true" ]; then
                  RABBITMQ_NAME="rabbitmq-preview-shared"
                else
                  RABBITMQ_NAME="rabbitmq-${{ env.APP_NAME }}"
                fi
                echo "Provisioning RabbitMQ: $RABBITMQ_NAME"
                ssh dokku rabbitmq:exists $RABBITMQ_NAME 2>/dev/null || ssh dokku rabbitmq:create $RABBITMQ_NAME
                ssh dokku rabbitmq:link $RABBITMQ_NAME ${{ env.APP_NAME }} 2>/dev/null || true
              fi
            fi

            # Elasticsearch
            if yq e '.services.elasticsearch.enabled' .dokku/services.yml 2>/dev/null | grep -q "true"; then
              PREVIEW_ENABLED=$(yq e '.services.elasticsearch.environments.preview.enabled // true' .dokku/services.yml)
              if [ "$PREVIEW_ENABLED" != "false" ]; then
                SHARED=$(yq e '.services.elasticsearch.environments.preview.shared // false' .dokku/services.yml)
                if [ "$SHARED" == "true" ]; then
                  ES_NAME="elasticsearch-preview-shared"
                else
                  ES_NAME="elasticsearch-${{ env.APP_NAME }}"
                fi
                echo "Provisioning Elasticsearch: $ES_NAME"
                ssh dokku elasticsearch:exists $ES_NAME 2>/dev/null || ssh dokku elasticsearch:create $ES_NAME
                ssh dokku elasticsearch:link $ES_NAME ${{ env.APP_NAME }} 2>/dev/null || true
              fi
            fi
          fi

      - name: Configure preview environment
        env:
          ALL_VARS: ${{ toJSON(vars) }}
        run: |
          DOMAIN="${{ env.APP_NAME }}.${{ secrets.BASE_DOMAIN }}"

          echo "Configuring preview environment..."

          # Start with required vars
          CONFIG_VARS="APP_ENV=preview APP_NAME=${{ env.APP_NAME }} APP_URL=https://$DOMAIN AGENT_NAME=${{ env.APP_NAME }} PR_NUMBER=${{ env.PR_NUMBER }} GIT_REV=${{ github.sha }}"

          # Loop through all environment variables from GitHub environment
          for key in $(echo "$ALL_VARS" | jq -r 'keys[]'); do
            value=$(echo "$ALL_VARS" | jq -r --arg k "$key" '.[$k]')
            [ -n "$value" ] && CONFIG_VARS="$CONFIG_VARS $key=$value"
          done

          # Clear existing config and set fresh values to ensure changes are applied
          ssh dokku config:clear --no-restart ${{ env.APP_NAME }} 2>/dev/null || true
          ssh dokku config:set --no-restart ${{ env.APP_NAME }} $CONFIG_VARS

          # Configure domain
          ssh dokku domains:clear ${{ env.APP_NAME }} 2>/dev/null || true
          ssh dokku domains:add ${{ env.APP_NAME }} "$DOMAIN"

          # Set resource limits (smaller for previews)
          MEMORY="${{ inputs.memory_limit }}"
          CPU="${{ inputs.cpu_limit }}"
          [ -z "$MEMORY" ] && MEMORY="256m"
          [ -z "$CPU" ] && CPU="0.5"
          ssh dokku resource:limit ${{ env.APP_NAME }} --memory $MEMORY --cpu $CPU || true

      - name: Deploy preview
        run: |
          echo "Deploying preview..."

          git remote add dokku dokku@${{ secrets.DOKKU_HOST }}:${{ env.APP_NAME }} 2>/dev/null || \
          git remote set-url dokku dokku@${{ secrets.DOKKU_HOST }}:${{ env.APP_NAME }}

          GIT_SSH_COMMAND="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            git push dokku HEAD:refs/heads/main --force

      - name: Enable SSL
        run: |
          echo "Enabling SSL..."
          DOMAIN="${{ env.APP_NAME }}.${{ secrets.BASE_DOMAIN }}"
          ssh dokku letsencrypt:enable ${{ env.APP_NAME }} || true

      - name: Add HTTP authentication (optional)
        env:
          PREVIEW_AUTH_USER: ${{ secrets.PREVIEW_AUTH_USER }}
          PREVIEW_AUTH_PASSWORD: ${{ secrets.PREVIEW_AUTH_PASSWORD }}
        run: |
          # Protect preview apps with basic auth if configured
          if [ -n "$PREVIEW_AUTH_USER" ] && [ -n "$PREVIEW_AUTH_PASSWORD" ]; then
            echo "Enabling HTTP authentication..."
            ssh dokku http-auth:enable ${{ env.APP_NAME }} \
              "$PREVIEW_AUTH_USER" \
              "$PREVIEW_AUTH_PASSWORD" || true
          fi

      - name: Verify deployment
        id: verify
        run: |
          DOMAIN="${{ env.APP_NAME }}.${{ secrets.BASE_DOMAIN }}"

          echo "Waiting for preview to be ready..."
          sleep 15

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$DOMAIN/health" 2>/dev/null || echo "000")

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
            echo "âœ… Preview is ready!"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            # Try without /health
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$DOMAIN/" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
              echo "âœ… Preview is ready!"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Preview returned HTTP $HTTP_STATUS"
              echo "status=warning" >> $GITHUB_OUTPUT
            fi
          fi

          echo "url=https://$DOMAIN" >> $GITHUB_OUTPUT

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const domain = `${{ env.APP_NAME }}.${{ secrets.BASE_DOMAIN }}`;
            const url = `https://${domain}`;
            const status = '${{ steps.verify.outputs.status }}' === 'success' ? 'âœ… Deployed' : 'âš ï¸ Deployed (check logs)';

            // Find existing bot comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Environment')
            );

            const body = `## ğŸš€ Preview Environment

            | Status | URL |
            |--------|-----|
            | ${status} | [${url}](${url}) |

            **Commit:** \`${{ github.sha }}\`
            **Branch:** \`${{ github.head_ref }}\`

            ---
            <sub>This preview will be automatically destroyed when the PR is closed or merged.</sub>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Cleanup Preview
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cleanup-preview:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Cleanup preview services
        run: |
          if [ -f ".dokku/services.yml" ]; then
            # Install yq
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq

            # Only destroy non-shared services
            # PostgreSQL
            SHARED=$(yq e '.services.postgres.environments.preview.shared // false' .dokku/services.yml 2>/dev/null)
            if [ "$SHARED" != "true" ]; then
              DB_NAME="postgres-${{ env.APP_NAME }}"
              echo "Destroying PostgreSQL: $DB_NAME"
              ssh -i ~/.ssh/deploy_key dokku@${{ secrets.DOKKU_HOST }} \
                postgres:destroy $DB_NAME --force 2>/dev/null || true
            fi

            # Redis
            SHARED=$(yq e '.services.redis.environments.preview.shared // false' .dokku/services.yml 2>/dev/null)
            if [ "$SHARED" != "true" ]; then
              REDIS_NAME="redis-${{ env.APP_NAME }}"
              echo "Destroying Redis: $REDIS_NAME"
              ssh -i ~/.ssh/deploy_key dokku@${{ secrets.DOKKU_HOST }} \
                redis:destroy $REDIS_NAME --force 2>/dev/null || true
            fi

            # MongoDB
            SHARED=$(yq e '.services.mongo.environments.preview.shared // false' .dokku/services.yml 2>/dev/null)
            if [ "$SHARED" != "true" ]; then
              MONGO_NAME="mongo-${{ env.APP_NAME }}"
              echo "Destroying MongoDB: $MONGO_NAME"
              ssh -i ~/.ssh/deploy_key dokku@${{ secrets.DOKKU_HOST }} \
                mongo:destroy $MONGO_NAME --force 2>/dev/null || true
            fi

            # MySQL
            SHARED=$(yq e '.services.mysql.environments.preview.shared // false' .dokku/services.yml 2>/dev/null)
            if [ "$SHARED" != "true" ]; then
              MYSQL_NAME="mysql-${{ env.APP_NAME }}"
              echo "Destroying MySQL: $MYSQL_NAME"
              ssh -i ~/.ssh/deploy_key dokku@${{ secrets.DOKKU_HOST }} \
                mysql:destroy $MYSQL_NAME --force 2>/dev/null || true
            fi

            # RabbitMQ
            SHARED=$(yq e '.services.rabbitmq.environments.preview.shared // false' .dokku/services.yml 2>/dev/null)
            if [ "$SHARED" != "true" ]; then
              RABBITMQ_NAME="rabbitmq-${{ env.APP_NAME }}"
              echo "Destroying RabbitMQ: $RABBITMQ_NAME"
              ssh -i ~/.ssh/deploy_key dokku@${{ secrets.DOKKU_HOST }} \
                rabbitmq:destroy $RABBITMQ_NAME --force 2>/dev/null || true
            fi

            # Elasticsearch
            SHARED=$(yq e '.services.elasticsearch.environments.preview.shared // false' .dokku/services.yml 2>/dev/null)
            if [ "$SHARED" != "true" ]; then
              ES_NAME="elasticsearch-${{ env.APP_NAME }}"
              echo "Destroying Elasticsearch: $ES_NAME"
              ssh -i ~/.ssh/deploy_key dokku@${{ secrets.DOKKU_HOST }} \
                elasticsearch:destroy $ES_NAME --force 2>/dev/null || true
            fi
          fi

      - name: Destroy preview app
        run: |
          echo "Destroying preview app: ${{ env.APP_NAME }}"
          ssh -i ~/.ssh/deploy_key dokku@${{ secrets.DOKKU_HOST }} \
            apps:destroy ${{ env.APP_NAME }} --force || true

      - name: Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Environment')
            );

            if (botComment) {
              const mergedOrClosed = context.payload.pull_request.merged ? 'merged' : 'closed';
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: `## ğŸš€ Preview Environment

                | Status |
                |--------|
                | ğŸ—‘ï¸ Destroyed (PR ${mergedOrClosed}) |

                ---
                <sub>Preview environments are automatically cleaned up when PRs are closed.</sub>`
              });
            }
