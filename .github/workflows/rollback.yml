# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# rollback.yml - Manual Rollback Workflow
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#
# Manually trigger a rollback to a previous release.
# Useful when a deployment causes issues and you need to quickly revert.
#
# Required Secrets:
#   - DOKKU_HOST: Dokku server hostname
#   - DOKKU_SSH_PRIVATE_KEY: SSH private key for deployment
#
# Optional Secrets:
#   - SLACK_WEBHOOK_URL: Slack notifications
#
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: Rollback

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name to rollback (leave empty for repo name)'
        required: false
        type: string
      environment:
        description: 'Environment suffix'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      release:
        description: 'Release version to rollback to (leave empty for previous)'
        required: false
        type: string
      confirm:
        description: 'Type "ROLLBACK" to confirm'
        required: true
        type: string

jobs:
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'ROLLBACK'

    steps:
      - name: Determine app name
        id: app
        run: |
          BASE_APP="${{ github.event.inputs.app_name }}"
          if [ -z "$BASE_APP" ]; then
            BASE_APP="${{ github.event.repository.name }}"
          fi

          case "${{ github.event.inputs.environment }}" in
            production)
              APP_NAME="$BASE_APP"
              ;;
            staging)
              APP_NAME="${BASE_APP}-staging"
              ;;
            development)
              APP_NAME="${BASE_APP}-dev"
              ;;
          esac

          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "Rolling back: $APP_NAME"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          cat >> ~/.ssh/config << EOF
          Host dokku
            HostName ${{ secrets.DOKKU_HOST }}
            User dokku
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: List available releases
        run: |
          echo "Available releases for ${{ steps.app.outputs.app_name }}:"
          echo ""
          ssh dokku releases:list ${{ steps.app.outputs.app_name }} || \
            echo "No releases found (or releases plugin not available)"

      - name: Get current release
        id: current
        run: |
          CURRENT=$(ssh dokku config:get ${{ steps.app.outputs.app_name }} GIT_REV 2>/dev/null || echo "unknown")
          echo "current_rev=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current revision: $CURRENT"

      - name: Pre-rollback database backup
        run: |
          APP="${{ steps.app.outputs.app_name }}"
          echo "Creating pre-rollback backup..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # PostgreSQL backup
          DB_NAME="postgres-$APP"
          if ssh dokku postgres:exists "$DB_NAME" 2>/dev/null; then
            BACKUP_DIR="/var/backups/dokku/postgres/$APP"
            BACKUP_FILE="$BACKUP_DIR/pre-rollback_${TIMESTAMP}.gz"

            echo "Backing up PostgreSQL: $DB_NAME"
            ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
            if ssh dokku postgres:export "$DB_NAME" 2>/dev/null | gzip | \
              ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"; then
              echo "  ‚úÖ Saved: $BACKUP_FILE"
            else
              echo "  ‚ö†Ô∏è Backup failed (continuing with rollback)"
            fi
          fi

          # MySQL backup
          DB_NAME="mysql-$APP"
          if ssh dokku mysql:exists "$DB_NAME" 2>/dev/null; then
            BACKUP_DIR="/var/backups/dokku/mysql/$APP"
            BACKUP_FILE="$BACKUP_DIR/pre-rollback_${TIMESTAMP}.gz"

            echo "Backing up MySQL: $DB_NAME"
            ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
            if ssh dokku mysql:export "$DB_NAME" 2>/dev/null | gzip | \
              ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"; then
              echo "  ‚úÖ Saved: $BACKUP_FILE"
            else
              echo "  ‚ö†Ô∏è Backup failed (continuing with rollback)"
            fi
          fi

          echo "Pre-rollback backup complete"

      - name: Perform rollback
        id: rollback
        run: |
          APP="${{ steps.app.outputs.app_name }}"
          RELEASE="${{ github.event.inputs.release }}"

          if [ -n "$RELEASE" ]; then
            echo "Rolling back $APP to release $RELEASE..."
            ssh dokku releases:rollback "$APP" "$RELEASE"
            echo "target_release=$RELEASE" >> $GITHUB_OUTPUT
          else
            echo "Rolling back $APP to previous release..."
            ssh dokku releases:rollback "$APP"
            echo "target_release=previous" >> $GITHUB_OUTPUT
          fi

      - name: Verify rollback
        id: verify
        run: |
          APP="${{ steps.app.outputs.app_name }}"

          # Get app domain
          DOMAIN=$(ssh dokku domains:report "$APP" --domains-app-vhosts 2>/dev/null | head -1)

          if [ -z "$DOMAIN" ]; then
            echo "‚ö†Ô∏è No domain found for $APP"
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "domain=none" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "Waiting for app to restart..."
          sleep 15

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$DOMAIN/health" --max-time 10 2>/dev/null || echo "000")

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
            echo "‚úÖ Rollback successful! App is responding with HTTP $HTTP_STATUS"
            echo "üåê https://$DOMAIN"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è App returned HTTP $HTTP_STATUS after rollback"
            echo "Check logs: ssh dokku@server logs $APP"
            echo "status=warning" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0

          APP="${{ steps.app.outputs.app_name }}"
          PREV_REV="${{ steps.current.outputs.current_rev }}"
          TARGET="${{ steps.rollback.outputs.target_release }}"
          STATUS="${{ steps.verify.outputs.status }}"
          DOMAIN="${{ steps.verify.outputs.domain }}"

          if [ "${{ job.status }}" == "success" ] && [ "$STATUS" == "success" ]; then
            COLOR="warning"
            TITLE="Rollback Successful"
          else
            COLOR="danger"
            TITLE="Rollback Completed (verify manually)"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"fields\": [
                  {\"title\": \"App\", \"value\": \"$APP\", \"short\": true},
                  {\"title\": \"Environment\", \"value\": \"${{ github.event.inputs.environment }}\", \"short\": true},
                  {\"title\": \"Rolled back to\", \"value\": \"$TARGET\", \"short\": true},
                  {\"title\": \"Previous Rev\", \"value\": \"$PREV_REV\", \"short\": true},
                  {\"title\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"URL\", \"value\": \"https://$DOMAIN\", \"short\": true}
                ],
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true

  cancelled:
    name: Rollback Cancelled
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'ROLLBACK'
    steps:
      - name: Cancelled
        run: |
          echo "‚ùå Rollback cancelled - confirmation text did not match"
          echo "You entered: '${{ github.event.inputs.confirm }}'"
          echo "Expected: 'ROLLBACK'"
          exit 1
