# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# rollback.yml - Manual Rollback Workflow
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#
# Manually trigger a rollback to a previous release.
# Useful when a deployment causes issues and you need to quickly revert.
#
# Required Secrets:
#   - DOKKU_HOST: Dokku server hostname
#   - DOKKU_SSH_PRIVATE_KEY: SSH private key for deployment
#
# Optional Secrets:
#   - SLACK_WEBHOOK_URL: Slack notifications
#   - DISCORD_WEBHOOK_URL: Discord notifications
#
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: Rollback

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name to rollback (leave empty for repo name)'
        required: false
        type: string
      environment:
        description: 'Environment suffix'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      release:
        description: 'Release version to rollback to (leave empty for previous)'
        required: false
        type: string
      confirm:
        description: 'Type "ROLLBACK" to confirm'
        required: true
        type: string

jobs:
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'ROLLBACK'

    steps:
      - name: Determine app name
        id: app
        run: |
          BASE_APP="${{ github.event.inputs.app_name }}"
          if [ -z "$BASE_APP" ]; then
            BASE_APP="${{ github.event.repository.name }}"
          fi

          case "${{ github.event.inputs.environment }}" in
            production)
              APP_NAME="$BASE_APP"
              ;;
            staging)
              APP_NAME="${BASE_APP}-staging"
              ;;
            development)
              APP_NAME="${BASE_APP}-dev"
              ;;
          esac

          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "Rolling back: $APP_NAME"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          cat >> ~/.ssh/config << EOF
          Host dokku
            HostName ${{ secrets.DOKKU_HOST }}
            User dokku
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Get release history
        id: releases
        run: |
          APP="${{ steps.app.outputs.app_name }}"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  Release History for $APP"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""

          # Get current release info
          CURRENT_VERSION=$(ssh dokku config:get "$APP" RELEASE_VERSION 2>/dev/null || echo "")
          CURRENT_SHA=$(ssh dokku config:get "$APP" RELEASE_SHA 2>/dev/null || echo "")
          HISTORY_B64=$(ssh dokku config:get "$APP" RELEASE_HISTORY_B64 2>/dev/null || echo "")

          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT

          if [ -z "$CURRENT_VERSION" ]; then
            echo "‚ö†Ô∏è No release tracking found for this app"
            echo "   Release tracking is enabled automatically when deploying via GitHub workflow"
            echo ""
            # Fall back to GIT_REV
            GIT_REV=$(ssh dokku config:get "$APP" GIT_REV 2>/dev/null || echo "unknown")
            echo "Current deployment: $GIT_REV"
            echo "current_sha=$GIT_REV" >> $GITHUB_OUTPUT
            echo "has_releases=false" >> $GITHUB_OUTPUT
          else
            echo "Current Release: v$CURRENT_VERSION (${CURRENT_SHA:0:7})"
            echo ""

            if [ -n "$HISTORY_B64" ]; then
              HISTORY=$(echo "$HISTORY_B64" | base64 -d 2>/dev/null)
              if echo "$HISTORY" | jq . >/dev/null 2>&1; then
                echo "VERSION   COMMIT    DATE         DEPLOYED BY     MESSAGE"
                echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                echo "$HISTORY" | jq -r '.[] | "v\(.version|tostring|.[0:7])      \(.short)    \(.timestamp | split("T")[0])   \(.actor[0:14])   \(.message[0:30])"'
                echo ""
                echo "has_releases=true" >> $GITHUB_OUTPUT
                echo "release_history<<EOF" >> $GITHUB_OUTPUT
                echo "$HISTORY" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT
              fi
            fi
          fi

      - name: Pre-rollback database backup
        run: |
          APP="${{ steps.app.outputs.app_name }}"
          echo "Creating pre-rollback backup..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # PostgreSQL backup
          DB_NAME="postgres-$APP"
          if ssh dokku postgres:exists "$DB_NAME" 2>/dev/null; then
            BACKUP_DIR="/var/backups/dokku/postgres/$APP"
            BACKUP_FILE="$BACKUP_DIR/pre-rollback_${TIMESTAMP}.gz"

            echo "Backing up PostgreSQL: $DB_NAME"
            ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
            if ssh dokku postgres:export "$DB_NAME" 2>/dev/null | gzip | \
              ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"; then
              echo "  ‚úÖ Saved: $BACKUP_FILE"
            else
              echo "  ‚ö†Ô∏è Backup failed (continuing with rollback)"
            fi
          fi

          # MySQL backup
          DB_NAME="mysql-$APP"
          if ssh dokku mysql:exists "$DB_NAME" 2>/dev/null; then
            BACKUP_DIR="/var/backups/dokku/mysql/$APP"
            BACKUP_FILE="$BACKUP_DIR/pre-rollback_${TIMESTAMP}.gz"

            echo "Backing up MySQL: $DB_NAME"
            ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
            if ssh dokku mysql:export "$DB_NAME" 2>/dev/null | gzip | \
              ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"; then
              echo "  ‚úÖ Saved: $BACKUP_FILE"
            else
              echo "  ‚ö†Ô∏è Backup failed (continuing with rollback)"
            fi
          fi

          echo "Pre-rollback backup complete"

      - name: Perform rollback
        id: rollback
        run: |
          APP="${{ steps.app.outputs.app_name }}"
          TARGET="${{ github.event.inputs.release }}"
          HAS_RELEASES="${{ steps.releases.outputs.has_releases }}"

          # Find target SHA
          TARGET_SHA=""
          TARGET_VERSION=""

          if [ "$HAS_RELEASES" == "true" ]; then
            HISTORY='${{ steps.releases.outputs.release_history }}'

            if [ -z "$TARGET" ]; then
              # Default to previous release (index 1 in array)
              TARGET_SHA=$(echo "$HISTORY" | jq -r '.[1].sha // empty')
              TARGET_VERSION=$(echo "$HISTORY" | jq -r '.[1].version // empty')
              echo "Rolling back to previous release: v$TARGET_VERSION"
            else
              # Remove 'v' prefix if present
              TARGET="${TARGET#v}"

              # Check if target is version number or SHA
              if [[ "$TARGET" =~ ^[0-9]+$ ]]; then
                TARGET_SHA=$(echo "$HISTORY" | jq -r ".[] | select(.version == $TARGET) | .sha")
                TARGET_VERSION="$TARGET"
              else
                TARGET_SHA=$(echo "$HISTORY" | jq -r ".[] | select(.sha | startswith(\"$TARGET\") or .short == \"$TARGET\") | .sha" | head -1)
                TARGET_VERSION=$(echo "$HISTORY" | jq -r ".[] | select(.sha | startswith(\"$TARGET\") or .short == \"$TARGET\") | .version" | head -1)
              fi
              echo "Rolling back to release v$TARGET_VERSION"
            fi
          else
            # No release history - use provided SHA directly
            if [ -n "$TARGET" ]; then
              TARGET_SHA="$TARGET"
              TARGET_VERSION="unknown"
              echo "Rolling back to commit: $TARGET"
            else
              echo "::error::No release history and no target specified"
              exit 1
            fi
          fi

          if [ -z "$TARGET_SHA" ]; then
            echo "::error::Could not find target release: $TARGET"
            exit 1
          fi

          echo "target_sha=$TARGET_SHA" >> $GITHUB_OUTPUT
          echo "target_version=$TARGET_VERSION" >> $GITHUB_OUTPUT

          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  Rolling back $APP"
          echo "  Target: v$TARGET_VERSION (${TARGET_SHA:0:7})"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""

          # Try docker image rollback first (fastest if image exists)
          if ssh dokku git:from-image "$APP" "dokku/$APP:$TARGET_SHA" 2>/dev/null; then
            echo "‚úÖ Rollback via cached image successful"
          else
            # Try rebuilding from git
            echo "Cached image not available, trying git rebuild..."
            if ssh dokku ps:rebuild "$APP" 2>/dev/null; then
              echo "‚úÖ Rebuild successful"
            else
              echo "::error::Automatic rollback failed"
              echo ""
              echo "To rollback manually, run from the repo:"
              echo "  git push dokku $TARGET_SHA:main --force"
              exit 1
            fi
          fi

      - name: Verify rollback
        id: verify
        run: |
          APP="${{ steps.app.outputs.app_name }}"

          # Get app domain
          DOMAIN=$(ssh dokku domains:report "$APP" --domains-app-vhosts 2>/dev/null | head -1)

          if [ -z "$DOMAIN" ]; then
            echo "‚ö†Ô∏è No domain found for $APP"
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "domain=none" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "Waiting for app to restart..."
          sleep 15

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$DOMAIN/health" --max-time 10 2>/dev/null || echo "000")

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
            echo "‚úÖ Rollback successful! App is responding with HTTP $HTTP_STATUS"
            echo "üåê https://$DOMAIN"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è App returned HTTP $HTTP_STATUS after rollback"
            echo "Check logs: ssh dokku@server logs $APP"
            echo "status=warning" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0

          APP="${{ steps.app.outputs.app_name }}"
          PREV_VERSION="${{ steps.releases.outputs.current_version }}"
          PREV_SHA="${{ steps.releases.outputs.current_sha }}"
          TARGET_VERSION="${{ steps.rollback.outputs.target_version }}"
          TARGET_SHA="${{ steps.rollback.outputs.target_sha }}"
          STATUS="${{ steps.verify.outputs.status }}"
          DOMAIN="${{ steps.verify.outputs.domain }}"

          if [ "${{ job.status }}" == "success" ] && [ "$STATUS" == "success" ]; then
            COLOR="warning"
            TITLE="‚è™ Rollback Successful"
          else
            COLOR="danger"
            TITLE="‚ö†Ô∏è Rollback Completed (verify manually)"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"fields\": [
                  {\"title\": \"App\", \"value\": \"$APP\", \"short\": true},
                  {\"title\": \"Environment\", \"value\": \"${{ github.event.inputs.environment }}\", \"short\": true},
                  {\"title\": \"Rolled back to\", \"value\": \"v$TARGET_VERSION (${TARGET_SHA:0:7})\", \"short\": true},
                  {\"title\": \"From version\", \"value\": \"v$PREV_VERSION (${PREV_SHA:0:7})\", \"short\": true},
                  {\"title\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"URL\", \"value\": \"https://$DOMAIN\", \"short\": true}
                ],
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          [ -z "$DISCORD_WEBHOOK_URL" ] && exit 0

          APP="${{ steps.app.outputs.app_name }}"
          PREV_VERSION="${{ steps.releases.outputs.current_version }}"
          PREV_SHA="${{ steps.releases.outputs.current_sha }}"
          TARGET_VERSION="${{ steps.rollback.outputs.target_version }}"
          TARGET_SHA="${{ steps.rollback.outputs.target_sha }}"
          STATUS="${{ steps.verify.outputs.status }}"
          DOMAIN="${{ steps.verify.outputs.domain }}"

          if [ "${{ job.status }}" == "success" ] && [ "$STATUS" == "success" ]; then
            COLOR=16776960
            TITLE="‚è™ Rollback Successful"
          else
            COLOR=15158332
            TITLE="‚ö†Ô∏è Rollback Completed (verify manually)"
          fi

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"App\", \"value\": \"$APP\", \"inline\": true},
                  {\"name\": \"Environment\", \"value\": \"${{ github.event.inputs.environment }}\", \"inline\": true},
                  {\"name\": \"Rolled back to\", \"value\": \"v$TARGET_VERSION (${TARGET_SHA:0:7})\", \"inline\": true},
                  {\"name\": \"From version\", \"value\": \"v$PREV_VERSION (${PREV_SHA:0:7})\", \"inline\": true},
                  {\"name\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                  {\"name\": \"URL\", \"value\": \"https://$DOMAIN\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"Rollback Workflow\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL" || true

  cancelled:
    name: Rollback Cancelled
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'ROLLBACK'
    steps:
      - name: Cancelled
        run: |
          echo "‚ùå Rollback cancelled - confirmation text did not match"
          echo "You entered: '${{ github.event.inputs.confirm }}'"
          echo "Expected: 'ROLLBACK'"
          exit 1
