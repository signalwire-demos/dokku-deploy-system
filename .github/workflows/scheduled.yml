# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# scheduled.yml - Scheduled Maintenance Tasks
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Runs scheduled maintenance tasks:
#   - Cleanup orphaned apps (apps whose repos no longer exist, closed PR previews)
#   - Renew SSL certificates
#   - Health checks for all apps
#   - Backup databases (daily at 2 AM UTC)
#
# Required Secrets:
#   - DOKKU_HOST: Dokku server hostname
#   - DOKKU_SSH_PRIVATE_KEY: SSH private key
#   - GH_ORG_TOKEN: GitHub token with repo read access (for orphan detection)
#
# Optional Secrets:
#   - SLACK_WEBHOOK_URL: Slack notifications
#   - DISCORD_WEBHOOK_URL: Discord notifications
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Scheduled Maintenance

on:
  schedule:
    # Run daily at 6 AM UTC (cleanup, certs, health)
    - cron: '0 6 * * *'
    # Run daily at 2 AM UTC (backups)
    - cron: '0 2 * * *'

  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - cleanup-orphans
          - renew-certs
          - health-check
          - backup-databases
      dry_run:
        description: 'Dry run (cleanup only - show what would be deleted)'
        required: false
        type: boolean
        default: false

env:
  GH_ORG: signalwire-demos

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Cleanup Orphaned Apps
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cleanup-orphans:
    name: Cleanup Orphaned Apps
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.task == 'all' || github.event.inputs.task == 'cleanup-orphans'
    outputs:
      orphans_found: ${{ steps.cleanup.outputs.orphans_found }}
      orphans_list: ${{ steps.cleanup.outputs.orphans_list }}
      apps_destroyed: ${{ steps.cleanup.outputs.apps_destroyed }}

    steps:
      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          cat >> ~/.ssh/config << EOF
          Host dokku
            HostName ${{ secrets.DOKKU_HOST }}
            User dokku
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

          ssh dokku version

      - name: Cleanup orphaned apps
        id: cleanup
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN || github.token }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Scanning for orphaned apps..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Get list of all Dokku apps
          DOKKU_APPS=$(ssh dokku apps:list | tail -n +2)

          if [ -z "$DOKKU_APPS" ]; then
            echo "No apps found on Dokku server"
            echo "orphans_found=0" >> $GITHUB_OUTPUT
            echo "apps_destroyed=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          ORPHANS=""
          ORPHAN_COUNT=0

          for APP in $DOKKU_APPS; do
            # Check if this is a PR preview app
            if [[ "$APP" =~ ^(.+)-pr-([0-9]+)$ ]]; then
              BASE_APP="${BASH_REMATCH[1]}"
              PR_NUMBER="${BASH_REMATCH[2]}"

              # Check if repo exists
              if ! gh repo view "${{ env.GH_ORG }}/${BASE_APP}" --json name >/dev/null 2>&1; then
                echo "Orphaned PR preview: $APP (repo ${{ env.GH_ORG }}/${BASE_APP} not found)"
                ORPHANS="$ORPHANS $APP"
                ORPHAN_COUNT=$((ORPHAN_COUNT + 1))
              else
                # Repo exists, check if PR is still open
                PR_STATE=$(gh pr view "$PR_NUMBER" --repo "${{ env.GH_ORG }}/${BASE_APP}" --json state -q '.state' 2>/dev/null || echo "NOT_FOUND")
                if [ "$PR_STATE" != "OPEN" ]; then
                  echo "Orphaned PR preview: $APP (PR #$PR_NUMBER is $PR_STATE)"
                  ORPHANS="$ORPHANS $APP"
                  ORPHAN_COUNT=$((ORPHAN_COUNT + 1))
                else
                  echo "App OK: $APP (PR #$PR_NUMBER is open)"
                fi
              fi
            else
              # Regular app - extract base name (remove -staging, -dev suffixes)
              BASE_APP=$(echo "$APP" | sed 's/-staging$//' | sed 's/-dev$//')

              # Check if repo exists in the org
              if ! gh repo view "${{ env.GH_ORG }}/${BASE_APP}" --json name >/dev/null 2>&1; then
                echo "Orphaned app found: $APP (repo ${{ env.GH_ORG }}/${BASE_APP} not found)"
                ORPHANS="$ORPHANS $APP"
                ORPHAN_COUNT=$((ORPHAN_COUNT + 1))
              else
                echo "App OK: $APP (repo exists)"
              fi
            fi
          done

          echo "orphans_found=$ORPHAN_COUNT" >> $GITHUB_OUTPUT
          echo "orphans_list=${ORPHANS}" >> $GITHUB_OUTPUT

          if [ -z "$ORPHANS" ]; then
            echo ""
            echo "No orphaned apps found!"
            echo "apps_destroyed=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Found $ORPHAN_COUNT orphaned app(s)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ "$DRY_RUN" == "true" ]; then
            echo ""
            echo "[DRY RUN] Would destroy the following apps:"
            for APP in $ORPHANS; do
              echo "  - $APP"
            done
            echo "apps_destroyed=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          DESTROYED=0
          for APP in $ORPHANS; do
            echo ""
            echo "Cleaning up orphan: $APP"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

            # Cleanup services
            SERVICES="postgres redis mongo mysql rabbitmq elasticsearch"
            for SERVICE in $SERVICES; do
              SERVICE_NAME="${SERVICE}-${APP}"
              if ssh dokku ${SERVICE}:exists "$SERVICE_NAME" 2>/dev/null; then
                echo "  Destroying service: $SERVICE_NAME"
                ssh dokku ${SERVICE}:unlink "$SERVICE_NAME" "$APP" 2>/dev/null || true
                ssh dokku ${SERVICE}:destroy "$SERVICE_NAME" --force 2>/dev/null || true
              fi
            done

            # Destroy the app
            echo "  Destroying app: $APP"
            ssh dokku apps:destroy "$APP" --force
            DESTROYED=$((DESTROYED + 1))
          done

          echo "apps_destroyed=$DESTROYED" >> $GITHUB_OUTPUT

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Orphan cleanup complete! Destroyed $DESTROYED app(s)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Notify Slack - Cleanup Results
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0

          ORPHANS="${{ steps.cleanup.outputs.orphans_found }}"
          DESTROYED="${{ steps.cleanup.outputs.apps_destroyed }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          if [ "${{ job.status }}" == "success" ]; then
            if [ "$ORPHANS" == "0" ] || [ -z "$ORPHANS" ]; then
              COLOR="good"
              TITLE="Cleanup: No orphaned apps found"
            elif [ "$DRY_RUN" == "true" ]; then
              COLOR="warning"
              TITLE="Cleanup (Dry Run): Found $ORPHANS orphaned app(s)"
            else
              COLOR="good"
              TITLE="Cleanup: Destroyed $DESTROYED orphaned app(s)"
            fi
          else
            COLOR="danger"
            TITLE="Cleanup: Failed"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"fields\": [
                  {\"title\": \"Task\", \"value\": \"Orphan Cleanup\", \"short\": true},
                  {\"title\": \"Trigger\", \"value\": \"${{ github.event_name }}\", \"short\": true}
                ],
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true

      - name: Notify Discord - Cleanup Results
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          [ -z "$DISCORD_WEBHOOK_URL" ] && exit 0

          ORPHANS="${{ steps.cleanup.outputs.orphans_found }}"
          DESTROYED="${{ steps.cleanup.outputs.apps_destroyed }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          if [ "${{ job.status }}" == "success" ]; then
            if [ "$ORPHANS" == "0" ] || [ -z "$ORPHANS" ]; then
              COLOR=3066993
              TITLE="ğŸ§¹ Cleanup: No orphaned apps found"
            elif [ "$DRY_RUN" == "true" ]; then
              COLOR=16776960
              TITLE="ğŸ” Cleanup (Dry Run): Found $ORPHANS orphaned app(s)"
            else
              COLOR=3066993
              TITLE="ğŸ—‘ï¸ Cleanup: Destroyed $DESTROYED orphaned app(s)"
            fi
          else
            COLOR=15158332
            TITLE="âŒ Cleanup: Failed"
          fi

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"Task\", \"value\": \"Orphan Cleanup\", \"inline\": true},
                  {\"name\": \"Trigger\", \"value\": \"${{ github.event_name }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Scheduled Maintenance\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Renew SSL Certificates
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  renew-certs:
    name: Renew SSL Certificates
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.task == 'all' || github.event.inputs.task == 'renew-certs'
    outputs:
      certs_renewed: ${{ steps.renew.outputs.certs_renewed }}

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          cat >> ~/.ssh/config << EOF
          Host dokku
            HostName ${{ secrets.DOKKU_HOST }}
            User dokku
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Renew all certificates
        id: renew
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Renewing SSL certificates..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          OUTPUT=$(ssh dokku letsencrypt:auto-renew 2>&1) || true
          echo "$OUTPUT"

          # Count renewed certs (look for "Renewing" in output)
          # Use grep -c but capture result properly (grep exits 1 when no match)
          RENEWED=$(echo "$OUTPUT" | grep -c "Renewing") || RENEWED=0
          echo "certs_renewed=$RENEWED" >> $GITHUB_OUTPUT

          echo ""
          echo "Certificate status:"
          ssh dokku letsencrypt:list || true

      - name: Notify Slack - Cert Renewal Results
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0

          RENEWED="${{ steps.renew.outputs.certs_renewed }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR="good"
            if [ "$RENEWED" == "0" ] || [ -z "$RENEWED" ]; then
              TITLE="SSL Renewal: All certificates up to date"
            else
              TITLE="SSL Renewal: Renewed $RENEWED certificate(s)"
            fi
          else
            COLOR="danger"
            TITLE="SSL Renewal: Failed"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"fields\": [
                  {\"title\": \"Task\", \"value\": \"Certificate Renewal\", \"short\": true},
                  {\"title\": \"Trigger\", \"value\": \"${{ github.event_name }}\", \"short\": true}
                ],
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true

      - name: Notify Discord - Cert Renewal Results
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          [ -z "$DISCORD_WEBHOOK_URL" ] && exit 0

          RENEWED="${{ steps.renew.outputs.certs_renewed }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR=3066993
            if [ "$RENEWED" == "0" ] || [ -z "$RENEWED" ]; then
              TITLE="ğŸ”’ SSL Renewal: All certificates up to date"
            else
              TITLE="ğŸ”’ SSL Renewal: Renewed $RENEWED certificate(s)"
            fi
          else
            COLOR=15158332
            TITLE="âŒ SSL Renewal: Failed"
          fi

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"Task\", \"value\": \"Certificate Renewal\", \"inline\": true},
                  {\"name\": \"Trigger\", \"value\": \"${{ github.event_name }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Scheduled Maintenance\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Health Check All Apps
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  health-check:
    name: Health Check All Apps
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.task == 'all' || github.event.inputs.task == 'health-check'
    outputs:
      healthy_count: ${{ steps.check.outputs.healthy }}
      unhealthy_count: ${{ steps.check.outputs.unhealthy }}
      unhealthy_apps: ${{ steps.check.outputs.unhealthy_apps }}

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          cat >> ~/.ssh/config << EOF
          Host dokku
            HostName ${{ secrets.DOKKU_HOST }}
            User dokku
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Check all apps
        id: check
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Running health checks..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Get all apps
          APPS=$(ssh dokku apps:list 2>/dev/null | tail -n +2)

          if [ -z "$APPS" ]; then
            echo "No apps found"
            echo "healthy=0" >> $GITHUB_OUTPUT
            echo "unhealthy=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          HEALTHY=0
          UNHEALTHY=0
          UNHEALTHY_APPS=""

          # Create health results JSON for dashboard
          echo '{"timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","results":[' > /tmp/health_results.json
          FIRST_RESULT=true

          for APP in $APPS; do
            # Get app domain
            DOMAIN=$(ssh dokku domains:report "$APP" --domains-app-vhosts 2>/dev/null | head -1)

            if [ -z "$DOMAIN" ]; then
              echo "âš ï¸  $APP: No domain configured"
              continue
            fi

            # Check health endpoint with response time
            RESPONSE=$(curl -s -w "\n%{http_code}\n%{time_total}" "https://$DOMAIN/health" --max-time 10 2>/dev/null || echo -e "\n000\n0")
            HTTP_STATUS=$(echo "$RESPONSE" | tail -2 | head -1)
            RESPONSE_TIME=$(echo "$RESPONSE" | tail -1)

            if [ "$HTTP_STATUS" == "000" ]; then
              # Try root endpoint
              RESPONSE=$(curl -s -w "\n%{http_code}\n%{time_total}" "https://$DOMAIN/" --max-time 10 2>/dev/null || echo -e "\n000\n0")
              HTTP_STATUS=$(echo "$RESPONSE" | tail -2 | head -1)
              RESPONSE_TIME=$(echo "$RESPONSE" | tail -1)
            fi

            # Convert response time to milliseconds
            RESPONSE_TIME_MS=$(echo "$RESPONSE_TIME * 1000" | bc 2>/dev/null | cut -d. -f1 || echo "0")
            [ -z "$RESPONSE_TIME_MS" ] && RESPONSE_TIME_MS=0

            # Determine status
            if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
              echo "âœ… $APP: HTTP $HTTP_STATUS (${RESPONSE_TIME_MS}ms) - https://$DOMAIN"
              HEALTHY=$((HEALTHY + 1))
              STATUS="healthy"
            else
              echo "âŒ $APP: HTTP $HTTP_STATUS (${RESPONSE_TIME_MS}ms) - https://$DOMAIN"
              UNHEALTHY=$((UNHEALTHY + 1))
              UNHEALTHY_APPS="$UNHEALTHY_APPS $APP"
              STATUS="unhealthy"
            fi

            # Add to JSON results
            if [ "$FIRST_RESULT" = true ]; then
              FIRST_RESULT=false
            else
              echo "," >> /tmp/health_results.json
            fi
            echo "{\"app\":\"$APP\",\"status\":\"$STATUS\",\"http_code\":$HTTP_STATUS,\"response_ms\":$RESPONSE_TIME_MS,\"url\":\"https://$DOMAIN\"}" >> /tmp/health_results.json
          done

          echo ']}' >> /tmp/health_results.json

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Summary: $HEALTHY healthy, $UNHEALTHY unhealthy"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT
          echo "unhealthy=$UNHEALTHY" >> $GITHUB_OUTPUT
          echo "unhealthy_apps=${UNHEALTHY_APPS}" >> $GITHUB_OUTPUT

          # Store results for potential dashboard update
          cat /tmp/health_results.json

          # Exit with error if any apps are unhealthy
          if [ "$UNHEALTHY" -gt 0 ]; then
            exit 1
          fi

      - name: Notify Slack - Health Check Results
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0

          HEALTHY="${{ steps.check.outputs.healthy }}"
          UNHEALTHY="${{ steps.check.outputs.unhealthy }}"
          UNHEALTHY_APPS="${{ steps.check.outputs.unhealthy_apps }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR="good"
            TITLE="Health Check: All $HEALTHY app(s) healthy"
          else
            COLOR="danger"
            TITLE="Health Check: $UNHEALTHY app(s) unhealthy"
          fi

          # Build fields JSON
          FIELDS="[{\"title\": \"Healthy\", \"value\": \"$HEALTHY\", \"short\": true}, {\"title\": \"Unhealthy\", \"value\": \"$UNHEALTHY\", \"short\": true}"

          if [ -n "$UNHEALTHY_APPS" ]; then
            FIELDS="$FIELDS, {\"title\": \"Unhealthy Apps\", \"value\": \"$UNHEALTHY_APPS\", \"short\": false}"
          fi

          FIELDS="$FIELDS]"

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"fields\": $FIELDS,
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true

      - name: Notify Discord - Health Check Results
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          [ -z "$DISCORD_WEBHOOK_URL" ] && exit 0

          HEALTHY="${{ steps.check.outputs.healthy }}"
          UNHEALTHY="${{ steps.check.outputs.unhealthy }}"
          UNHEALTHY_APPS="${{ steps.check.outputs.unhealthy_apps }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR=3066993
            TITLE="ğŸ’š Health Check: All $HEALTHY app(s) healthy"
          else
            COLOR=15158332
            TITLE="â¤ï¸ Health Check: $UNHEALTHY app(s) unhealthy"
          fi

          # Build fields JSON
          FIELDS="[{\"name\": \"Healthy\", \"value\": \"$HEALTHY\", \"inline\": true}, {\"name\": \"Unhealthy\", \"value\": \"$UNHEALTHY\", \"inline\": true}"

          if [ -n "$UNHEALTHY_APPS" ]; then
            FIELDS="$FIELDS, {\"name\": \"Unhealthy Apps\", \"value\": \"$UNHEALTHY_APPS\", \"inline\": false}"
          fi

          FIELDS="$FIELDS]"

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"color\": $COLOR,
                \"fields\": $FIELDS,
                \"footer\": {\"text\": \"Scheduled Maintenance\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Backup Databases
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  backup-databases:
    name: Backup Databases
    runs-on: ubuntu-latest
    # Run at 2 AM UTC (second cron) or when explicitly requested
    if: (github.event_name == 'schedule' && github.event.schedule == '0 2 * * *') || github.event.inputs.task == 'all' || github.event.inputs.task == 'backup-databases'
    outputs:
      backup_count: ${{ steps.backup.outputs.backup_count }}

    steps:
      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          cat >> ~/.ssh/config << EOF
          Host dokku
            HostName ${{ secrets.DOKKU_HOST }}
            User dokku
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Backup all databases
        id: backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_COUNT=0

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Scheduled Database Backup"
          echo "  Time: $TIMESTAMP"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Get list of all apps
          APPS=$(ssh dokku apps:list | tail -n +2)

          for APP in $APPS; do
            # Skip preview apps (they use shared databases)
            if [[ "$APP" == *"-pr-"* ]]; then
              continue
            fi

            # PostgreSQL
            DB_NAME="postgres-$APP"
            if ssh dokku postgres:exists "$DB_NAME" 2>/dev/null; then
              BACKUP_DIR="/var/backups/dokku/postgres/$APP"
              BACKUP_FILE="$BACKUP_DIR/${TIMESTAMP}.gz"

              echo "Backing up PostgreSQL: $DB_NAME"
              ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
              if ssh dokku postgres:export "$DB_NAME" 2>/dev/null | gzip | \
                ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"; then
                SIZE=$(ssh dokku@${{ secrets.DOKKU_HOST }} "ls -lh $BACKUP_FILE | awk '{print \$5}'" 2>/dev/null || echo "?")
                echo "  âœ… $BACKUP_FILE ($SIZE)"
                BACKUP_COUNT=$((BACKUP_COUNT + 1))
              else
                echo "  âŒ Failed"
              fi
            fi

            # MySQL
            DB_NAME="mysql-$APP"
            if ssh dokku mysql:exists "$DB_NAME" 2>/dev/null; then
              BACKUP_DIR="/var/backups/dokku/mysql/$APP"
              BACKUP_FILE="$BACKUP_DIR/${TIMESTAMP}.gz"

              echo "Backing up MySQL: $DB_NAME"
              ssh dokku@${{ secrets.DOKKU_HOST }} "mkdir -p $BACKUP_DIR"
              if ssh dokku mysql:export "$DB_NAME" 2>/dev/null | gzip | \
                ssh dokku@${{ secrets.DOKKU_HOST }} "cat > $BACKUP_FILE"; then
                SIZE=$(ssh dokku@${{ secrets.DOKKU_HOST }} "ls -lh $BACKUP_FILE | awk '{print \$5}'" 2>/dev/null || echo "?")
                echo "  âœ… $BACKUP_FILE ($SIZE)"
                BACKUP_COUNT=$((BACKUP_COUNT + 1))
              else
                echo "  âŒ Failed"
              fi
            fi
          done

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Backups completed: $BACKUP_COUNT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo "backup_count=$BACKUP_COUNT" >> $GITHUB_OUTPUT

      - name: Cleanup old backups
        run: |
          echo "Cleaning up backups older than 14 days..."
          ssh dokku@${{ secrets.DOKKU_HOST }} "find /var/backups/dokku -type f -mtime +14 -delete 2>/dev/null || true"

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0

          BACKUP_COUNT="${{ steps.backup.outputs.backup_count }}"

          if [ "$BACKUP_COUNT" -gt 0 ]; then
            COLOR="good"
            TITLE="Database Backup: $BACKUP_COUNT backup(s) created"
          else
            COLOR="warning"
            TITLE="Database Backup: No databases to backup"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          [ -z "$DISCORD_WEBHOOK_URL" ] && exit 0

          BACKUP_COUNT="${{ steps.backup.outputs.backup_count }}"

          if [ "$BACKUP_COUNT" -gt 0 ]; then
            COLOR=3066993
            TITLE="ğŸ’¾ Database Backup: $BACKUP_COUNT backup(s) created"
          else
            COLOR=16776960
            TITLE="ğŸ’¾ Database Backup: No databases to backup"
          fi

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"color\": $COLOR,
                \"footer\": {\"text\": \"Scheduled Maintenance\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL" || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Summary Notification
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [cleanup-orphans, renew-certs, health-check]
    # Only run for the 6 AM schedule (not the 2 AM backup schedule)
    if: always() && github.event_name == 'schedule' && github.event.schedule == '0 6 * * *'

    steps:
      - name: Notify Slack - Daily Summary
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0

          # Determine overall status
          CLEANUP_STATUS="${{ needs.cleanup-orphans.result }}"
          CERTS_STATUS="${{ needs.renew-certs.result }}"
          HEALTH_STATUS="${{ needs.health-check.result }}"

          if [ "$CLEANUP_STATUS" == "success" ] && [ "$CERTS_STATUS" == "success" ] && [ "$HEALTH_STATUS" == "success" ]; then
            COLOR="good"
            TITLE="Daily Maintenance: All tasks completed successfully"
          elif [ "$HEALTH_STATUS" != "success" ]; then
            COLOR="danger"
            TITLE="Daily Maintenance: Health check issues detected"
          else
            COLOR="warning"
            TITLE="Daily Maintenance: Some tasks had issues"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$TITLE\",
                \"fields\": [
                  {\"title\": \"Cleanup\", \"value\": \"$CLEANUP_STATUS\", \"short\": true},
                  {\"title\": \"SSL Renewal\", \"value\": \"$CERTS_STATUS\", \"short\": true},
                  {\"title\": \"Health Check\", \"value\": \"$HEALTH_STATUS\", \"short\": true}
                ],
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true

      - name: Notify Discord - Daily Summary
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          [ -z "$DISCORD_WEBHOOK_URL" ] && exit 0

          # Determine overall status
          CLEANUP_STATUS="${{ needs.cleanup-orphans.result }}"
          CERTS_STATUS="${{ needs.renew-certs.result }}"
          HEALTH_STATUS="${{ needs.health-check.result }}"

          if [ "$CLEANUP_STATUS" == "success" ] && [ "$CERTS_STATUS" == "success" ] && [ "$HEALTH_STATUS" == "success" ]; then
            COLOR=3066993
            TITLE="ğŸ“Š Daily Maintenance: All tasks completed successfully"
          elif [ "$HEALTH_STATUS" != "success" ]; then
            COLOR=15158332
            TITLE="ğŸ“Š Daily Maintenance: Health check issues detected"
          else
            COLOR=16776960
            TITLE="ğŸ“Š Daily Maintenance: Some tasks had issues"
          fi

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"Cleanup\", \"value\": \"$CLEANUP_STATUS\", \"inline\": true},
                  {\"name\": \"SSL Renewal\", \"value\": \"$CERTS_STATUS\", \"inline\": true},
                  {\"name\": \"Health Check\", \"value\": \"$HEALTH_STATUS\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Scheduled Maintenance\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL" || true
