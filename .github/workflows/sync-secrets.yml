# ═══════════════════════════════════════════════════════════════════════════════
# sync-secrets.yml - Sync Secrets from External Vaults
# ═══════════════════════════════════════════════════════════════════════════════
#
# Synchronizes secrets from external vault providers to GitHub Environment Variables.
#
# Supported Providers:
#   - AWS Secrets Manager
#   - HashiCorp Vault
#   - 1Password (via CLI)
#
# Usage:
#   1. Go to Actions → Sync Secrets → Run workflow
#   2. Select the provider and enter connection details
#   3. Secrets are synced to the specified GitHub environment
#
# ═══════════════════════════════════════════════════════════════════════════════

name: Sync Secrets

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'Secret provider'
        type: choice
        options:
          - aws-secrets-manager
          - hashicorp-vault
          - 1password
        required: true
      target_repo:
        description: 'Target repository (e.g., signalwire-demos/myapp)'
        required: true
        type: string
      target_environment:
        description: 'Target GitHub environment'
        type: choice
        options:
          - production
          - staging
          - development
        required: true
      secret_path:
        description: 'Secret path/name in vault (e.g., myapp/production)'
        required: true
        type: string
      dry_run:
        description: 'Preview changes without applying'
        type: boolean
        default: true

  # Allow scheduled sync
  schedule:
    - cron: '0 4 * * *'  # Daily at 4 AM UTC

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # AWS Secrets Manager
  # ═══════════════════════════════════════════════════════════════════════════
  sync-aws:
    name: Sync from AWS Secrets Manager
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.provider == 'aws-secrets-manager'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Fetch secrets from AWS
        id: fetch
        run: |
          echo "Fetching secret: ${{ inputs.secret_path }}"

          # Get the secret value
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "${{ inputs.secret_path }}" \
            --query SecretString \
            --output text)

          if [ -z "$SECRET_JSON" ]; then
            echo "::error::Secret not found: ${{ inputs.secret_path }}"
            exit 1
          fi

          # Parse and display keys (not values)
          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "  Secrets found:"
          echo "═══════════════════════════════════════════════════════"
          echo "$SECRET_JSON" | jq -r 'keys[]' | while read key; do
            echo "  • $key"
          done

          # Store for next step (base64 encoded to preserve JSON)
          echo "secrets=$(echo "$SECRET_JSON" | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: Preview changes
        if: inputs.dry_run
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "  DRY RUN - Preview Only"
          echo "═══════════════════════════════════════════════════════"
          echo ""
          echo "  Target: ${{ inputs.target_repo }}"
          echo "  Environment: ${{ inputs.target_environment }}"
          echo ""

          # Get current variables
          echo "  Current variables in environment:"
          CURRENT=$(gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables \
            --jq '.variables[].name' 2>/dev/null || echo "")

          if [ -n "$CURRENT" ]; then
            echo "$CURRENT" | while read var; do
              echo "    • $var"
            done
          else
            echo "    (none)"
          fi

          echo ""
          echo "  Variables to sync:"
          echo "${{ steps.fetch.outputs.secrets }}" | base64 -d | jq -r 'keys[]' | while read key; do
            echo "    • $key"
          done

          echo ""
          echo "  Run again with dry_run=false to apply changes."

      - name: Sync to GitHub environment
        if: "!inputs.dry_run"
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "  Syncing secrets to GitHub"
          echo "═══════════════════════════════════════════════════════"

          # Decode secrets
          SECRET_JSON=$(echo "${{ steps.fetch.outputs.secrets }}" | base64 -d)

          # Sync each secret as an environment variable
          echo "$SECRET_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            echo "  Syncing: $key"

            # Check if variable exists
            EXISTS=$(gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables/$key \
              --jq '.name' 2>/dev/null || echo "")

            if [ -n "$EXISTS" ]; then
              # Update existing
              gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables/$key \
                -X PATCH -f value="$value" > /dev/null
            else
              # Create new
              gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables \
                -X POST -f name="$key" -f value="$value" > /dev/null
            fi
          done

          echo ""
          echo "✅ Sync complete!"

  # ═══════════════════════════════════════════════════════════════════════════
  # HashiCorp Vault
  # ═══════════════════════════════════════════════════════════════════════════
  sync-vault:
    name: Sync from HashiCorp Vault
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.provider == 'hashicorp-vault'

    steps:
      - name: Install Vault CLI
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install -y vault

      - name: Authenticate to Vault
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
        run: |
          # Try token auth first, then AppRole
          if [ -n "$VAULT_TOKEN" ]; then
            echo "Using token authentication"
            export VAULT_TOKEN
          elif [ -n "$VAULT_ROLE_ID" ] && [ -n "$VAULT_SECRET_ID" ]; then
            echo "Using AppRole authentication"
            VAULT_TOKEN=$(vault write -field=token auth/approle/login \
              role_id="$VAULT_ROLE_ID" \
              secret_id="$VAULT_SECRET_ID")
            echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV
          else
            echo "::error::No Vault authentication configured"
            echo "Set either VAULT_TOKEN or VAULT_ROLE_ID + VAULT_SECRET_ID"
            exit 1
          fi

          echo "VAULT_ADDR=$VAULT_ADDR" >> $GITHUB_ENV

      - name: Fetch secrets from Vault
        id: fetch
        env:
          VAULT_ADDR: ${{ env.VAULT_ADDR }}
          VAULT_TOKEN: ${{ env.VAULT_TOKEN }}
        run: |
          echo "Fetching secret: ${{ inputs.secret_path }}"

          # Read secret from KV v2 engine
          SECRET_JSON=$(vault kv get -format=json "${{ inputs.secret_path }}" | jq '.data.data')

          if [ -z "$SECRET_JSON" ] || [ "$SECRET_JSON" == "null" ]; then
            # Try KV v1 engine
            SECRET_JSON=$(vault read -format=json "${{ inputs.secret_path }}" | jq '.data')
          fi

          if [ -z "$SECRET_JSON" ] || [ "$SECRET_JSON" == "null" ]; then
            echo "::error::Secret not found: ${{ inputs.secret_path }}"
            exit 1
          fi

          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "  Secrets found:"
          echo "═══════════════════════════════════════════════════════"
          echo "$SECRET_JSON" | jq -r 'keys[]' | while read key; do
            echo "  • $key"
          done

          echo "secrets=$(echo "$SECRET_JSON" | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: Preview changes
        if: inputs.dry_run
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "  DRY RUN - Preview Only"
          echo "═══════════════════════════════════════════════════════"
          echo ""
          echo "  Target: ${{ inputs.target_repo }}"
          echo "  Environment: ${{ inputs.target_environment }}"
          echo ""
          echo "  Variables to sync:"
          echo "${{ steps.fetch.outputs.secrets }}" | base64 -d | jq -r 'keys[]' | while read key; do
            echo "    • $key"
          done
          echo ""
          echo "  Run again with dry_run=false to apply changes."

      - name: Sync to GitHub environment
        if: "!inputs.dry_run"
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "  Syncing secrets to GitHub"
          echo "═══════════════════════════════════════════════════════"

          SECRET_JSON=$(echo "${{ steps.fetch.outputs.secrets }}" | base64 -d)

          echo "$SECRET_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            echo "  Syncing: $key"

            EXISTS=$(gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables/$key \
              --jq '.name' 2>/dev/null || echo "")

            if [ -n "$EXISTS" ]; then
              gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables/$key \
                -X PATCH -f value="$value" > /dev/null
            else
              gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables \
                -X POST -f name="$key" -f value="$value" > /dev/null
            fi
          done

          echo ""
          echo "✅ Sync complete!"

  # ═══════════════════════════════════════════════════════════════════════════
  # 1Password
  # ═══════════════════════════════════════════════════════════════════════════
  sync-1password:
    name: Sync from 1Password
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.provider == '1password'

    steps:
      - name: Install 1Password CLI
        run: |
          curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
            sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
            sudo tee /etc/apt/sources.list.d/1password.list
          sudo apt-get update && sudo apt-get install -y 1password-cli

      - name: Authenticate to 1Password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          if [ -z "$OP_SERVICE_ACCOUNT_TOKEN" ]; then
            echo "::error::1Password service account token not configured"
            echo "Set OP_SERVICE_ACCOUNT_TOKEN secret"
            exit 1
          fi

          # Test authentication
          op whoami > /dev/null
          echo "✅ Authenticated to 1Password"

      - name: Fetch secrets from 1Password
        id: fetch
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          echo "Fetching item: ${{ inputs.secret_path }}"

          # Get item and extract fields
          # Format: vault/item or just item (uses default vault)
          ITEM_JSON=$(op item get "${{ inputs.secret_path }}" --format=json)

          if [ -z "$ITEM_JSON" ]; then
            echo "::error::Item not found: ${{ inputs.secret_path }}"
            exit 1
          fi

          # Extract fields as key-value pairs
          # Only include fields with values (skip empty ones)
          SECRET_JSON=$(echo "$ITEM_JSON" | jq '
            [.fields[] | select(.value != null and .value != "") | {key: .label, value: .value}]
            | from_entries
          ')

          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "  Secrets found:"
          echo "═══════════════════════════════════════════════════════"
          echo "$SECRET_JSON" | jq -r 'keys[]' | while read key; do
            echo "  • $key"
          done

          echo "secrets=$(echo "$SECRET_JSON" | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: Preview changes
        if: inputs.dry_run
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "  DRY RUN - Preview Only"
          echo "═══════════════════════════════════════════════════════"
          echo ""
          echo "  Target: ${{ inputs.target_repo }}"
          echo "  Environment: ${{ inputs.target_environment }}"
          echo ""
          echo "  Variables to sync:"
          echo "${{ steps.fetch.outputs.secrets }}" | base64 -d | jq -r 'keys[]' | while read key; do
            echo "    • $key"
          done
          echo ""
          echo "  Run again with dry_run=false to apply changes."

      - name: Sync to GitHub environment
        if: "!inputs.dry_run"
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "  Syncing secrets to GitHub"
          echo "═══════════════════════════════════════════════════════"

          SECRET_JSON=$(echo "${{ steps.fetch.outputs.secrets }}" | base64 -d)

          echo "$SECRET_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            echo "  Syncing: $key"

            EXISTS=$(gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables/$key \
              --jq '.name' 2>/dev/null || echo "")

            if [ -n "$EXISTS" ]; then
              gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables/$key \
                -X PATCH -f value="$value" > /dev/null
            else
              gh api repos/${{ inputs.target_repo }}/environments/${{ inputs.target_environment }}/variables \
                -X POST -f name="$key" -f value="$value" > /dev/null
            fi
          done

          echo ""
          echo "✅ Sync complete!"

  # ═══════════════════════════════════════════════════════════════════════════
  # Scheduled Sync - Run for all configured apps
  # ═══════════════════════════════════════════════════════════════════════════
  scheduled-sync:
    name: Scheduled Secret Sync
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for sync configuration
        id: config
        run: |
          if [ -f ".github/secrets-sync.yml" ]; then
            echo "has_config=true" >> $GITHUB_OUTPUT
          else
            echo "has_config=false" >> $GITHUB_OUTPUT
            echo "No secrets-sync.yml configuration found."
            echo "Create .github/secrets-sync.yml to enable scheduled sync."
          fi

      - name: Run scheduled sync
        if: steps.config.outputs.has_config == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          echo "═══════════════════════════════════════════════════════"
          echo "  Scheduled Secret Sync"
          echo "═══════════════════════════════════════════════════════"
          echo ""
          echo "Reading configuration from .github/secrets-sync.yml..."
          echo ""

          # Parse config and trigger individual syncs
          # Expected format:
          # syncs:
          #   - provider: aws-secrets-manager
          #     repo: signalwire-demos/myapp
          #     environment: production
          #     secret_path: myapp/production

          SYNCS=$(yq e '.syncs | length' .github/secrets-sync.yml)

          for i in $(seq 0 $((SYNCS - 1))); do
            PROVIDER=$(yq e ".syncs[$i].provider" .github/secrets-sync.yml)
            REPO=$(yq e ".syncs[$i].repo" .github/secrets-sync.yml)
            ENV=$(yq e ".syncs[$i].environment" .github/secrets-sync.yml)
            PATH=$(yq e ".syncs[$i].secret_path" .github/secrets-sync.yml)

            echo "Syncing: $REPO ($ENV) from $PROVIDER:$PATH"

            # Trigger the sync workflow
            gh workflow run sync-secrets.yml \
              -f provider="$PROVIDER" \
              -f target_repo="$REPO" \
              -f target_environment="$ENV" \
              -f secret_path="$PATH" \
              -f dry_run=false || echo "  ⚠️ Failed to trigger sync"
          done

          echo ""
          echo "Scheduled sync triggers complete."

  # ═══════════════════════════════════════════════════════════════════════════
  # Audit Log
  # ═══════════════════════════════════════════════════════════════════════════
  audit-log:
    name: Audit Log
    needs: [sync-aws, sync-vault, sync-1password]
    if: |
      always() &&
      github.event_name == 'workflow_dispatch' &&
      (needs.sync-aws.result == 'success' || needs.sync-vault.result == 'success' || needs.sync-1password.result == 'success')
    uses: ./.github/workflows/audit-log.yml
    with:
      action: sync-secrets
      app_name: ${{ inputs.target_repo }}
      environment: ${{ inputs.target_environment }}
      status: success
      metadata: '{"provider": "${{ inputs.provider }}", "secret_path": "${{ inputs.secret_path }}", "dry_run": "${{ inputs.dry_run }}"}'
    secrets: inherit
