# ═══════════════════════════════════════════════════════════════════════════════
# update-dashboard.yml - Update Deploy Dashboard
# ═══════════════════════════════════════════════════════════════════════════════
#
# Reusable workflow to update the deployment dashboard on GitHub Pages.
# Called after deploys, cleanups, and health checks to keep dashboard current.
#
# Dashboard location: https://signalwire-demos.github.io/dokku-deploy-system/
#
# ═══════════════════════════════════════════════════════════════════════════════

name: Update Dashboard

on:
  workflow_call:
    inputs:
      app_name:
        description: 'App name'
        required: true
        type: string
      action:
        description: 'Action type (deploy, cleanup, health-check)'
        required: true
        type: string
      status:
        description: 'Status (success, failure, healthy, unhealthy)'
        required: true
        type: string
      environment:
        description: 'Environment (production, staging, development, preview)'
        required: false
        type: string
        default: ''
      url:
        description: 'App URL'
        required: false
        type: string
        default: ''
      commit_sha:
        description: 'Commit SHA'
        required: false
        type: string
        default: ''
      actor:
        description: 'Who triggered the action'
        required: false
        type: string
        default: ''

  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        type: choice
        options:
          - refresh-all
          - init

jobs:
  update-dashboard:
    name: Update Dashboard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update apps.json
        run: |
          # Initialize apps.json if it doesn't exist
          if [ ! -f dashboard/apps.json ]; then
            mkdir -p dashboard
            echo '{"last_updated":"","apps":[]}' > dashboard/apps.json
          fi

          APP_NAME="${{ inputs.app_name }}"
          ACTION="${{ inputs.action }}"
          STATUS="${{ inputs.status }}"
          ENVIRONMENT="${{ inputs.environment }}"
          URL="${{ inputs.url }}"
          COMMIT_SHA="${{ inputs.commit_sha }}"
          ACTOR="${{ inputs.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # For refresh-all, just update timestamp
          if [ "$ACTION" == "refresh-all" ] || [ "$ACTION" == "init" ]; then
            jq --arg ts "$TIMESTAMP" '.last_updated = $ts' dashboard/apps.json > tmp.json && mv tmp.json dashboard/apps.json
            echo "Dashboard refreshed at $TIMESTAMP"
            exit 0
          fi

          # Update or add app entry
          if [ "$ACTION" == "deploy" ]; then
            # Check if app exists in JSON
            APP_EXISTS=$(jq --arg name "$APP_NAME" '.apps | map(select(.name == $name)) | length' dashboard/apps.json)

            if [ "$APP_EXISTS" -gt 0 ]; then
              # Update existing app
              jq --arg name "$APP_NAME" \
                 --arg status "$STATUS" \
                 --arg env "$ENVIRONMENT" \
                 --arg url "$URL" \
                 --arg sha "$COMMIT_SHA" \
                 --arg actor "$ACTOR" \
                 --arg ts "$TIMESTAMP" \
                 '(.apps[] | select(.name == $name)) |= . + {
                   status: $status,
                   environment: $env,
                   url: $url,
                   last_deploy: $ts,
                   last_deploy_by: $actor,
                   commit_sha: $sha
                 } | .last_updated = $ts' dashboard/apps.json > tmp.json && mv tmp.json dashboard/apps.json
            else
              # Add new app
              jq --arg name "$APP_NAME" \
                 --arg status "$STATUS" \
                 --arg env "$ENVIRONMENT" \
                 --arg url "$URL" \
                 --arg sha "$COMMIT_SHA" \
                 --arg actor "$ACTOR" \
                 --arg ts "$TIMESTAMP" \
                 '.apps += [{
                   name: $name,
                   status: $status,
                   environment: $env,
                   url: $url,
                   last_deploy: $ts,
                   last_deploy_by: $actor,
                   commit_sha: $sha,
                   uptime: {
                     status: "unknown",
                     response_time_ms: 0,
                     last_check: $ts
                   }
                 }] | .last_updated = $ts' dashboard/apps.json > tmp.json && mv tmp.json dashboard/apps.json
            fi

          elif [ "$ACTION" == "cleanup" ]; then
            # Remove app from dashboard
            jq --arg name "$APP_NAME" --arg ts "$TIMESTAMP" \
               '.apps = [.apps[] | select(.name != $name)] | .last_updated = $ts' \
               dashboard/apps.json > tmp.json && mv tmp.json dashboard/apps.json

          elif [ "$ACTION" == "health-check" ]; then
            # Update uptime info
            jq --arg name "$APP_NAME" \
               --arg status "$STATUS" \
               --arg ts "$TIMESTAMP" \
               '(.apps[] | select(.name == $name)).uptime |= . + {
                 status: $status,
                 last_check: $ts
               } | .last_updated = $ts' dashboard/apps.json > tmp.json && mv tmp.json dashboard/apps.json
          fi

          echo "Updated dashboard for $APP_NAME ($ACTION: $STATUS)"
          cat dashboard/apps.json

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dashboard/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update dashboard: ${{ inputs.app_name }} ${{ inputs.action }}"
            git push
          fi
