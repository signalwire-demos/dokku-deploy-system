#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# dokku-cli - Developer CLI for Dokku deployments
# ═══════════════════════════════════════════════════════════════════════════════
#
# A developer-friendly CLI wrapper for common Dokku operations.
# Simplifies app management, logging, deployment, and debugging.
#
# Installation:
#   chmod +x dokku-cli
#   sudo mv dokku-cli /usr/local/bin/
#
# Configuration:
#   Set DOKKU_HOST and SSH_KEY in your shell profile, or use a config file.
#
# ═══════════════════════════════════════════════════════════════════════════════

set -e

# ─────────────────────────────────────────────────────────────────────────────
# Configuration
# ─────────────────────────────────────────────────────────────────────────────

# Load config from file if exists
CONFIG_FILE="${HOME}/.dokku-cli"
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# Configuration (can be overridden by environment or config file)
DOKKU_HOST="${DOKKU_HOST:-dokku.yourdomain.com}"
SSH_KEY="${SSH_KEY:-${HOME}/.ssh/dokku_deploy}"
BASE_DOMAIN="${BASE_DOMAIN:-yourdomain.com}"

# ─────────────────────────────────────────────────────────────────────────────
# Colors and formatting
# ─────────────────────────────────────────────────────────────────────────────

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

log_info()    { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
log_error()   { echo -e "${RED}✗${NC} $1"; }
log_header()  { echo -e "\n${BOLD}${CYAN}$1${NC}\n"; }

# ─────────────────────────────────────────────────────────────────────────────
# SSH helper
# ─────────────────────────────────────────────────────────────────────────────

dokku_ssh() {
    if [ -f "$SSH_KEY" ]; then
        ssh -i "$SSH_KEY" "dokku@$DOKKU_HOST" "$@"
    else
        ssh "dokku@$DOKKU_HOST" "$@"
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Get app name (from argument or current git repo)
# ─────────────────────────────────────────────────────────────────────────────

get_app_name() {
    if [ -n "$1" ]; then
        echo "$1"
    elif git rev-parse --is-inside-work-tree &>/dev/null; then
        basename "$(git rev-parse --show-toplevel)"
    else
        log_error "No app name provided and not in a git repository"
        exit 1
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Commands
# ─────────────────────────────────────────────────────────────────────────────

cmd_list() {
    log_header "All Apps"
    dokku_ssh apps:list
}

cmd_info() {
    local APP=$(get_app_name "$1")
    log_header "App Info: $APP"

    echo -e "${BOLD}Status${NC}"
    dokku_ssh ps:report "$APP" 2>/dev/null || echo "  Not running"

    echo ""
    echo -e "${BOLD}Domains${NC}"
    dokku_ssh domains:report "$APP" 2>/dev/null || echo "  No domains"

    echo ""
    echo -e "${BOLD}SSL${NC}"
    dokku_ssh letsencrypt:list 2>/dev/null | grep -E "^$APP " || echo "  No SSL certificate"

    echo ""
    echo -e "${BOLD}Resources${NC}"
    dokku_ssh resource:report "$APP" 2>/dev/null || echo "  Default resources"
}

cmd_logs() {
    local APP=$(get_app_name "$1")
    local NUM="${2:---num 100}"
    log_info "Logs for $APP"
    dokku_ssh logs "$APP" $NUM
}

cmd_logs_follow() {
    local APP=$(get_app_name "$1")
    log_info "Following logs for $APP (Ctrl+C to stop)"
    dokku_ssh logs "$APP" -t
}

cmd_config() {
    local APP=$(get_app_name "$1")
    log_header "Environment Variables: $APP"
    dokku_ssh config:show "$APP"
}

cmd_config_set() {
    local APP=$(get_app_name "$1")
    shift
    if [ $# -eq 0 ]; then
        log_error "Usage: dokku-cli config:set [app] KEY=value [KEY2=value2 ...]"
        exit 1
    fi
    log_info "Setting config for $APP..."
    dokku_ssh config:set "$APP" "$@"
    log_success "Config updated"
}

cmd_config_unset() {
    local APP=$(get_app_name "$1")
    shift
    if [ $# -eq 0 ]; then
        log_error "Usage: dokku-cli config:unset [app] KEY [KEY2 ...]"
        exit 1
    fi
    log_info "Unsetting config for $APP..."
    dokku_ssh config:unset "$APP" "$@"
    log_success "Config updated"
}

cmd_shell() {
    local APP=$(get_app_name "$1")
    log_info "Opening shell for $APP..."
    dokku_ssh enter "$APP" web
}

cmd_run() {
    local APP=$(get_app_name "$1")
    shift
    if [ $# -eq 0 ]; then
        log_error "Usage: dokku-cli run [app] <command>"
        exit 1
    fi
    log_info "Running command in $APP..."
    dokku_ssh run "$APP" "$@"
}

cmd_restart() {
    local APP=$(get_app_name "$1")
    log_info "Restarting $APP..."
    dokku_ssh ps:restart "$APP"
    log_success "Restarted"
}

cmd_stop() {
    local APP=$(get_app_name "$1")
    log_warning "Stopping $APP..."
    dokku_ssh ps:stop "$APP"
    log_success "Stopped"
}

cmd_start() {
    local APP=$(get_app_name "$1")
    log_info "Starting $APP..."
    dokku_ssh ps:start "$APP"
    log_success "Started"
}

cmd_scale() {
    local APP=$(get_app_name "$1")
    shift
    if [ $# -eq 0 ]; then
        log_header "Current Scale: $APP"
        dokku_ssh ps:scale "$APP"
    else
        log_info "Scaling $APP..."
        dokku_ssh ps:scale "$APP" "$@"
        log_success "Scaled"
    fi
}

cmd_deploy() {
    local APP=$(get_app_name "$1")
    local BRANCH="${2:-HEAD}"

    log_header "Deploying $APP"

    # Check if we're in a git repo
    if ! git rev-parse --is-inside-work-tree &>/dev/null; then
        log_error "Not in a git repository"
        exit 1
    fi

    # Check for uncommitted changes
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
        log_warning "You have uncommitted changes"
        read -p "Continue anyway? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
            exit 1
        fi
    fi

    # Setup remote
    log_info "Configuring git remote..."
    git remote add dokku "dokku@$DOKKU_HOST:$APP" 2>/dev/null || \
    git remote set-url dokku "dokku@$DOKKU_HOST:$APP"

    # Deploy
    log_info "Pushing to Dokku..."
    if [ -f "$SSH_KEY" ]; then
        GIT_SSH_COMMAND="ssh -i $SSH_KEY" git push dokku "$BRANCH:main" --force
    else
        git push dokku "$BRANCH:main" --force
    fi

    log_success "Deployed!"
    echo ""
    log_info "URL: https://$APP.$BASE_DOMAIN"
}

cmd_rollback() {
    local APP=$(get_app_name "$1")
    local VERSION="$2"

    if [ -n "$VERSION" ]; then
        log_warning "Rolling back $APP to $VERSION..."
        dokku_ssh releases:rollback "$APP" "$VERSION"
    else
        log_warning "Rolling back $APP to previous version..."
        dokku_ssh releases:rollback "$APP"
    fi
    log_success "Rolled back"
}

cmd_releases() {
    local APP=$(get_app_name "$1")
    log_header "Releases: $APP"
    dokku_ssh releases:list "$APP"
}

cmd_create() {
    local APP="$1"
    if [ -z "$APP" ]; then
        log_error "Usage: dokku-cli create <app-name>"
        exit 1
    fi
    log_info "Creating app: $APP"
    dokku_ssh apps:create "$APP"
    log_success "Created"
    log_info "Domain: $APP.$BASE_DOMAIN"
}

cmd_destroy() {
    local APP=$(get_app_name "$1")

    log_warning "This will PERMANENTLY delete $APP and all its data!"
    echo ""
    read -p "Type the app name to confirm: " CONFIRM

    if [ "$CONFIRM" == "$APP" ]; then
        dokku_ssh apps:destroy "$APP" --force
        log_success "Destroyed $APP"
    else
        log_error "Confirmation failed. Aborting."
        exit 1
    fi
}

cmd_ssl() {
    local APP=$(get_app_name "$1")
    local ACTION="${2:-status}"

    case "$ACTION" in
        enable)
            log_info "Enabling SSL for $APP..."
            dokku_ssh letsencrypt:enable "$APP"
            log_success "SSL enabled"
            ;;
        disable)
            log_info "Disabling SSL for $APP..."
            dokku_ssh letsencrypt:disable "$APP"
            log_success "SSL disabled"
            ;;
        status|*)
            log_header "SSL Status: $APP"
            dokku_ssh letsencrypt:list 2>/dev/null | grep -E "^$APP |App " || echo "No SSL certificate"
            ;;
    esac
}

cmd_domains() {
    local APP=$(get_app_name "$1")
    local ACTION="$2"
    shift 2 2>/dev/null || true

    case "$ACTION" in
        add)
            if [ -z "$1" ]; then
                log_error "Usage: dokku-cli domains add [app] <domain>"
                exit 1
            fi
            log_info "Adding domain $1 to $APP..."
            dokku_ssh domains:add "$APP" "$1"
            log_success "Domain added"
            ;;
        remove)
            if [ -z "$1" ]; then
                log_error "Usage: dokku-cli domains remove [app] <domain>"
                exit 1
            fi
            log_info "Removing domain $1 from $APP..."
            dokku_ssh domains:remove "$APP" "$1"
            log_success "Domain removed"
            ;;
        *)
            log_header "Domains: $APP"
            dokku_ssh domains:report "$APP"
            ;;
    esac
}

cmd_db() {
    local APP=$(get_app_name "$1")
    local ACTION="${2:-info}"
    local SERVICE="${3:-postgres}"

    DB_NAME="$SERVICE-$APP"

    case "$ACTION" in
        create)
            log_info "Creating $SERVICE database: $DB_NAME"
            dokku_ssh "$SERVICE:create" "$DB_NAME"
            dokku_ssh "$SERVICE:link" "$DB_NAME" "$APP"
            log_success "Database created and linked"
            ;;
        connect)
            log_info "Connecting to $DB_NAME..."
            dokku_ssh "$SERVICE:connect" "$DB_NAME"
            ;;
        backup)
            local BACKUP_FILE="${APP}-$(date +%Y%m%d_%H%M%S).dump"
            log_info "Backing up to $BACKUP_FILE..."
            dokku_ssh "$SERVICE:export" "$DB_NAME" > "$BACKUP_FILE"
            log_success "Backup saved: $BACKUP_FILE"
            ;;
        info|*)
            log_header "Database: $DB_NAME"
            dokku_ssh "$SERVICE:info" "$DB_NAME" 2>/dev/null || echo "Database not found"
            ;;
    esac
}

cmd_setup() {
    log_header "Dokku CLI Setup"

    echo "This will create a configuration file at ~/.dokku-cli"
    echo ""

    read -p "Dokku host [$DOKKU_HOST]: " input_host
    DOKKU_HOST="${input_host:-$DOKKU_HOST}"

    read -p "SSH key path [$SSH_KEY]: " input_key
    SSH_KEY="${input_key:-$SSH_KEY}"

    read -p "Base domain [$BASE_DOMAIN]: " input_domain
    BASE_DOMAIN="${input_domain:-$BASE_DOMAIN}"

    cat > "$CONFIG_FILE" << EOF
# Dokku CLI Configuration
DOKKU_HOST="$DOKKU_HOST"
SSH_KEY="$SSH_KEY"
BASE_DOMAIN="$BASE_DOMAIN"
EOF

    log_success "Configuration saved to $CONFIG_FILE"

    echo ""
    log_info "Testing connection..."
    if dokku_ssh version 2>/dev/null; then
        log_success "Connected to Dokku!"
    else
        log_error "Could not connect to Dokku"
        log_info "Check your DOKKU_HOST and SSH_KEY settings"
    fi
}

cmd_help() {
    cat << 'EOF'
╔═══════════════════════════════════════════════════════════════════════════════╗
║                              DOKKU CLI                                         ║
║                   Developer tools for Dokku deployments                        ║
╚═══════════════════════════════════════════════════════════════════════════════╝

Usage: dokku-cli <command> [app] [options]

If [app] is not provided, it will be inferred from the current git repository.

GENERAL
  setup                      Configure CLI settings
  list                       List all apps
  create <name>              Create a new app
  destroy [app]              Permanently delete an app

APP INFO
  info [app]                 Show app information
  logs [app] [--num N]       View app logs (default: 100 lines)
  logs:follow [app]          Follow app logs in real-time

CONFIGURATION
  config [app]               Show environment variables
  config:set [app] K=V...    Set environment variables
  config:unset [app] K...    Remove environment variables

PROCESS MANAGEMENT
  restart [app]              Restart app
  start [app]                Start app
  stop [app]                 Stop app
  scale [app] [web=N...]     View or set process scaling
  shell [app]                Open interactive shell in app

DEPLOYMENT
  deploy [app] [branch]      Deploy app via git push
  rollback [app] [version]   Rollback to previous release
  releases [app]             List releases

SSL & DOMAINS
  ssl [app] [enable|disable] Manage SSL certificates
  domains [app]              List domains
  domains add [app] <domain> Add a domain
  domains remove [app] <d>   Remove a domain

DATABASE
  db [app] info [service]    Show database info
  db [app] create [service]  Create and link database
  db [app] connect [service] Connect to database shell
  db [app] backup [service]  Export database backup

RUN COMMANDS
  run [app] <command>        Run one-off command

EXAMPLES
  dokku-cli logs myapp --num 50
  dokku-cli config:set myapp DEBUG=true SECRET_KEY=abc123
  dokku-cli run myapp python manage.py migrate
  dokku-cli deploy myapp main
  dokku-cli db myapp create postgres

CONFIGURATION
  Settings are stored in ~/.dokku-cli
  Run 'dokku-cli setup' to configure.

EOF
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

case "${1:-help}" in
    # General
    setup)          cmd_setup ;;
    list|ls)        cmd_list ;;
    create)         cmd_create "$2" ;;
    destroy|delete) cmd_destroy "$2" ;;

    # Info
    info|status)    cmd_info "$2" ;;
    logs)           cmd_logs "$2" "$3" ;;
    logs:follow|lf) cmd_logs_follow "$2" ;;

    # Config
    config)         cmd_config "$2" ;;
    config:set)     shift; cmd_config_set "$@" ;;
    config:unset)   shift; cmd_config_unset "$@" ;;

    # Process
    restart)        cmd_restart "$2" ;;
    start)          cmd_start "$2" ;;
    stop)           cmd_stop "$2" ;;
    scale)          shift; cmd_scale "$@" ;;
    shell|sh)       cmd_shell "$2" ;;

    # Deploy
    deploy|push)    cmd_deploy "$2" "$3" ;;
    rollback|rb)    cmd_rollback "$2" "$3" ;;
    releases)       cmd_releases "$2" ;;

    # SSL & Domains
    ssl)            cmd_ssl "$2" "$3" ;;
    domains)        shift; cmd_domains "$@" ;;

    # Database
    db)             shift; cmd_db "$@" ;;

    # Run
    run)            shift; cmd_run "$@" ;;

    # Help
    help|--help|-h) cmd_help ;;
    version|--version|-v)
        echo "dokku-cli v1.0.0"
        ;;

    *)
        log_error "Unknown command: $1"
        echo "Run 'dokku-cli help' for usage"
        exit 1
        ;;
esac
